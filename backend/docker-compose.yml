services:
  postgres:
    image: postgres:16-alpine
    container_name: sps-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: sps_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      PGTZ: Asia/Ho_Chi_Minh
    ports:
      - "5434:5432"
    volumes:
      - sps_postgres_data:/var/lib/postgresql/data
      - ./src/main/resources/sql/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sps-network

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: sps-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - mosquitto_passwords:/mosquitto/config/passwords_vol
    networks:
      - sps-network
    # Initialize password file on first run
    command: >
      sh -c "
        if [ ! -f /mosquitto/config/passwords ]; then
          touch /mosquitto/config/passwords;
          mosquitto_passwd -b /mosquitto/config/passwords sps-backend $${MQTT_BACKEND_PASSWORD:-changeme_in_production};
          chown mosquitto:mosquitto /mosquitto/config/passwords;
        fi &&
        /usr/sbin/mosquitto -c /mosquitto/config/mosquitto.conf
      "

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sps-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Database configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/sps_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin
      # MQTT configuration
      MQTT_BROKER_URI: tcp://mosquitto:1883
      MQTT_USERNAME: sps-backend
      MQTT_PASSWORD: ${MQTT_BACKEND_PASSWORD:-changeme_in_production}
      MQTT_BROKER_HOST: ${MQTT_PUBLIC_HOST:-localhost}
      MQTT_BROKER_PORT: ${MQTT_PUBLIC_PORT:-1883}
      MQTT_PASSWORD_FILE: /mosquitto/config/passwords
    volumes:
      # Share mosquitto config for password file management
      - ./mosquitto/config:/mosquitto/config
    depends_on:
      postgres:
        condition: service_healthy
      mosquitto:
        condition: service_started
    networks:
      - sps-network

  adminer:
    image: adminer:latest
    container_name: sps-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres
    networks:
      - sps-network

volumes:
  sps_postgres_data:
    driver: local
  mosquitto_passwords:
    driver: local

networks:
  sps-network:
    driver: bridge
