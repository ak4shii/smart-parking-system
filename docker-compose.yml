services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: sps-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: sps_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      PGTZ: Asia/Ho_Chi_Minh
    ports:
      - "5434:5432"
    volumes:
      - sps_postgres_data:/var/lib/postgresql/data
      - ./backend/src/main/resources/sql/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sps-network

  # MQTT Broker
  mosquitto:
    build:
      context: ./backend/mosquitto
      dockerfile: Dockerfile
    container_name: sps-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    environment:
      MQTT_BACKEND_PASSWORD: ${MQTT_BACKEND_PASSWORD:-sps_backend_secret}
    volumes:
      - ./backend/mosquitto/config:/mosquitto/config
      - ./backend/mosquitto/data:/mosquitto/data
      - ./backend/mosquitto/log:/mosquitto/log
      - ./backend/mosquitto/passwords:/mosquitto/config/passwords_vol
    networks:
      - sps-network
    command: >
      sh -c "
        if [ ! -f /mosquitto/config/passwords ]; then
          touch /mosquitto/config/passwords;
          mosquitto_passwd -b /mosquitto/config/passwords sps-backend $${MQTT_BACKEND_PASSWORD:-changeme_in_production};
          chown mosquitto:mosquitto /mosquitto/config/passwords;
        fi &&
        /usr/sbin/mosquitto -c /mosquitto/config/mosquitto.conf
      "

  # Backend Spring Boot Application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sps-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Database configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/sps_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: admin

      # MQTT configuration
      MQTT_BROKER_URI: tcp://mosquitto:1883
      MQTT_USERNAME: sps-backend
      MQTT_PASSWORD: ${MQTT_BACKEND_PASSWORD:-changeme_in_production}
      MQTT_PASSWORD_FILE_PATH: /mosquitto/config/passwords
      MQTT_PUBLIC_HOST: ${MQTT_PUBLIC_HOST:-localhost}
      MQTT_PUBLIC_PORT: ${MQTT_PUBLIC_PORT:-1883}

      # Security configuration  
      SECURITY_ENABLED: "true"

      # Logging
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_INTEGRATION_MQTT: DEBUG
      LOGGING_LEVEL_ORG_ECLIPSE_PAHO_CLIENT_MQTTV3: DEBUG

      # --- S3 (presigned GET URLs) ---
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      S3_REGION: ${S3_REGION}
      S3_PRESIGN_EXPIRE_SECONDS: ${S3_PRESIGN_EXPIRE_SECONDS:-300}

      # --- AWS credentials (DO NOT commit real keys) ---
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:-}
    volumes:
      - ./backend/mosquitto/config:/mosquitto/config
      # Docker socket access for sending SIGHUP signal to Mosquitto
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      postgres:
        condition: service_healthy
      mosquitto:
        condition: service_started
    networks:
      - sps-network

  # Frontend React Application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sps-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - sps-network

  # Database Admin Interface
  adminer:
    image: adminer:latest
    container_name: sps-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres
    networks:
      - sps-network

volumes:
  sps_postgres_data:
    driver: local

networks:
  sps-network:
    driver: bridge
